<html>
<head>
	<title>YUI Calendar Tests</title>
	<link type="text/css" rel="stylesheet" href="../build/logger/assets/logger.css" />
	<link type="text/css" rel="stylesheet" href="../build/yuitest/assets/testlogger.css" />
	<link type="text/css" rel="stylesheet" href="../build/calendar/assets/skins/sam/calendar.css" />

	<script type="text/javascript" src="../build/yahoo/yahoo-min.js"></script>
	<script type="text/javascript" src="../build/dom/dom-min.js"></script>
	<script type="text/javascript" src="../build/event/event-min.js"></script>
	<script type="text/javascript" src="../build/logger/logger-min.js"></script>
	<script type="text/javascript" src="../build/yuitest/yuitest-beta-min.js"></script>
	<script type="text/javascript" src="../build/calendar/calendar-min.js"></script>
	
	<style type="text/css">
		.fail, .ignore, .pass {
			margin-left:10px;
		}
		
		ol.testlist li {
			margin: 10px 0 10px 0;
			list-style:none;
		}
		span.testname {
			color:#0000cc;
			font-family:monospace;
		}
	</style>

	<script type="text/javascript">
	(function() {

		var	Dom=YAHOO.util.Dom,
			TestCase = YAHOO.tool.TestCase,
			Assert=YAHOO.util.Assert,
			ObjectAssert=YAHOO.util.ObjectAssert,
			ArrayAssert=YAHOO.util.ArrayAssert,
			UserAction=YAHOO.util.UserAction, 
			testLogger;

		/**
		 * Temporary DateAssert, added when there was no YAHOO.util.DateAssert - need to change code to use YAHOO.util.DateAssert
		 */		
		var DateAssert = {

			/**
			 * Asserts if the expected and actual Dates passed in are the same, based on a comparison of fullyear, month and date fields.
			 * Time fields are not compared.
			 * 
			 * @param {Date} expected The expected date 
			 * @param {Date} actual The actual date
			 * @param {String} msg The message to display if assertion fails
			 * @throws YAHOO.util.ComparisonFailure
			 */
			datesAreSame : function(expected, actual, msg) {
				if (this._datesAreSame(expected, actual) === false) {
					throw new YAHOO.util.ComparisonFailure(msg || "Dates are not equal", expected, actual);
				}
			},
	
			/**
			 * Asserts if the expected and actual Date Arrays are the same.
			 * Ignores time differences between dates, similar to YAHOO.util.DateAssert.datesAreSame
			 * 
			 * The Arrays are the same only if they contain the same number of elements and all elements in
			 * the expected array are in the actual array, and visa versa. 
			 * 
			 * Additionally, if testOrder is true, asserts that Array entries are in the same order.
			 * 
			 * @param {Date[]} expected The expected array of Date objects
			 * @param {Date[]} actual The actual array of Date objects
			 * @param {boolean} testOrder if true, arrays are the same only if the order of Dates also match, 
			 * 							  if false, arrays can be the same even if they are ordered differently
			 * @param {String} msg The message to display if assertion fails
			 * @throws YAHOO.util.ComparisonFailure
			 */
			dateArraysAreSame : function(expected, actual, testOrder, msg) {
				if (YAHOO.lang.isArray(expected) === false || YAHOO.lang.isArray(actual) === false) {
					throw new YAHOO.util.ComparisonFailure(msg || "Date arrays are not both instances of Array", expected, actual);
				}
	
				if (expected.length !== actual.length) {
					throw new YAHOO.util.ComparisonFailure(msg || "Date arrays are not the same length", expected, actual);
				}
	
				var areEq = true;
				if (testOrder) {
					// already established lengths are same, so pick either one
					for (var i = 0; areEq && i < expected.length; i++) {
						if (this._datesAreSame(expected[i], actual[i]) === false) {
							areEq = false;
						}
					}
				} else {
					// All array1 in array2
					for (var j = 0; areEq && j < expected.length; j++) {
						if (this._containsDate(actual, expected[j]) === false) {
							areEq = false;
						}
					}
					// All array2 in array1
					for (var k = 0;areEq && k < actual.length; k++) {
						if (this._containsDate(expected, actual[k]) === false) {
							areEq = false;
						}
					}
				}
	
				if (areEq === false) {
					throw new YAHOO.util.ComparisonFailure(msg || "Date arrays are not equal", expected, actual);
				}
			},
	
			/**
			 * Asserts if an arrary of Dates contains a given Dates based on a comparison of 
			 * fullyear, month, and date fields. Time fields are not compared.
			 * 
			 * @param {Date[]} a Array of Date objects
			 * @param {Object} d The Date to test for
			 * @param {String} msg The message to display if assertion fails
			 * @throws YAHOO.util.AssertionError
			 */
			containsDate : function(a, d, msg) {
				if (this._containsDate(a, d) === false) {
					throw new YAHOO.util.AssertionError(msg || "Date not found in array.")
				}
			},
	
			// Checks without Assertion
			_datesAreSame : function(d1, d2) {
				return (d1.getFullYear() === d2.getFullYear() 
							&& d1.getMonth() === d2.getMonth() 
								&& d1.getDate() === d2.getDate());
			},

			_containsDate : function(a, d) {
				var found = false;
				for (var i = 0; found === false && i < a.length; i++) {
					if (this._datesAreSame(a[i], d)) {
						found = true;
					}
				}
				return found;
			}
		};

		/**
		 * Base Calendar Test Case Class
		 */
		function CalendarTestCase(template) {
			CalendarTestCase.superclass.constructor.call(this, template);
			this.container = null;
		};
	
		YAHOO.lang.extend(CalendarTestCase, TestCase);
		
		CalendarTestCase.prototype.widgetclass = YAHOO.widget.Calendar;
		CalendarTestCase.prototype.needsUI = true;
	
		CalendarTestCase.prototype.setUp = function() {
			this.container = document.createElement("div");
			this.container.id = "testCalContainer";
			document.body.appendChild(this.container);
		};
	
		CalendarTestCase.prototype.tearDown = function() {
			if (this.container != null) {
				document.body.removeChild(this.container);
			}
		};
			
		CalendarTestCase.prototype.createInstance = function(opts) {
			var cal = (opts) ? new this.widgetclass("testCal", "testCalContainer", opts) : new this.widgetclass("testCal", "testCalContainer");
			if (this.needsUI) cal.render();
			return cal;
		};
		
		CalendarTestCase.prototype._testConstruction = function() {
			var cal = this.createInstance();
			Assert.isObject(cal, "Failed to create basic instance");
			Assert.isInstanceOf(this.widgetclass, cal, "Failed to create basic instance");
			cal = null;
		};
			
		CalendarTestCase.prototype.getCfgProperty = function(cal, propertyName) {
			var isGrp = this.widgetclass === YAHOO.widget.CalendarGroup;
			return (isGrp) ? cal.pages[0].cfg.getProperty(propertyName) : cal.cfg.getProperty(propertyName);
		};
	
		CalendarTestCase.prototype.assertSelectedDates = function(cal, expected) {
			var dates = cal.getSelectedDates();
	
			Assert.isArray(dates, "getSelectedDates() should always return an array");
			if (expected.length > 0) {
				ArrayAssert.isNotEmpty(dates, "getSelectedDates() shoud not be empty");	
			}
			DateAssert.dateArraysAreSame(expected, dates, false, "getSelectedDates() does not contain the correct dates");
			DateAssert.dateArraysAreSame(expected, dates, true, "getSelectedDates() not returned in the correct order");
		};

		var apiTemplate = {

			needsUI : false,

			testConstruction: function() {
				this._testConstruction();
			},

			testSelectString: function() {

				var cal = this.createInstance();

				var testDtStr = "04/12/2007"; // month index is 0 based
				var testDt = [new Date(2007, 3, 12)];

				cal.select(testDtStr);
				this.assertSelectedDates(cal, testDt);

				cal = null;
			},

			testSelectStringArray: function() {
				var cal = this.createInstance({multi_select:true});

				// Ascending order, same as the output of getSelectedDates()
				var testDtStr = "04/12/2007, 05/02/2008, 02/16/2006-02/18/2006";
				var testDt = [new Date(2006, 1, 16), new Date(2006, 1, 17), 
									new Date(2006, 1, 18), new Date(2007, 3, 12),new Date(2008, 4, 2)];

				cal.select(testDtStr);
				this.assertSelectedDates(cal, testDt);

				cal = null;
			},

			testSelectDate: function() {
				var cal = this.createInstance();

				var testDt = new Date(2007, 3, 12);

				cal.select(testDt);
				this.assertSelectedDates(cal, [testDt]);

				cal = null;
			}, 

			testSelectDateArray: function() {
				var cal = this.createInstance({multi_select:true});
	
				// Ascending order, same as the output of getSelectedDates(). Test for mixed order?
				var testDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14)];
	
				cal.select(testDt);
				this.assertSelectedDates(cal, testDt);
				
				cal = null;
			},
			
			testSelectInsideRange: function() {
				var cal = this.createInstance({multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});

				var testDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14)];
				cal.select(testDt);

				this.assertSelectedDates(cal, testDt);

				cal = null;
			},

			testSelectOverlappingRange: function() {
				var cal = this.createInstance({multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});

				var testDt = [new Date(2006, 0, 1), new Date(2007, 3, 9), new Date(2007, 3, 10), new Date(2007, 3, 19), new Date(2007, 3, 20), new Date(2007, 3, 21), new Date(2008, 0, 1)];
				var expectedDt = [new Date(2007, 3, 10), new Date(2007, 3, 19), new Date(2007, 3, 20)];				

				cal.select(testDt);
				this.assertSelectedDates(cal, expectedDt);

				cal = null;
			},
			
			testSelectOutsideRange: function() {
				var cal = this.createInstance({multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});

				var testDt = [new Date(2007, 3, 1), new Date(2007, 3, 2), new Date(2007, 3, 3), new Date(2007, 3, 28), new Date(2007, 3, 29)];
				cal.select(testDt);

				this.assertSelectedDates(cal, []);

				cal = null;
			},
	
			testPageNav: function() {
				var cal = this.createInstance({pagedate:"11/2007"});
	
				cal.nextMonth();

				var pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2007, 11, 01), pgDate, "nextMonth()[1] set incorrect page date");

				cal.nextYear();

				pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2008, 11, 01), pgDate, "nextYear() set incorrect page date");

				cal.nextMonth();

				pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2009, 0, 01), pgDate, "nextMonth()[2] did not rollover year");

				cal.previousMonth();

				pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2008, 11, 01), pgDate, "previousMonth()[1] did not rollover year");

				cal.previousMonth();

				pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2008, 10, 01), pgDate, "previousMonth()[2] set incorrect page date");

				cal.previousYear();

				pgDate = this.getCfgProperty(cal, "pagedate");
				Assert.isInstanceOf(Date, pgDate, "Page date should be instanceof Date");
				DateAssert.datesAreSame(new Date(2007, 10, 01), pgDate, "previousYear() set incorrect page date");

				cal = null;
			}
		};
	
		var domTemplate = {
			
			needsUI: true,
	
			testConstruction: function() {
				this._testConstruction();
			},
	
			testSelectCell: function() {
				var cal = this.createInstance({pagedate:"4/2007", multi_select:true});
				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);
	
				var testDt = (grpCal) ? [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14), new Date(2007, 4, 10), new Date(2007, 4, 11), new Date(2007, 4, 12)]
								: [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14)];
	
				cal.selectCell(11);
				cal.selectCell(12);
				cal.selectCell(13);
				cal.selectCell(35); // Should not be selected. OOM
	
				this.assertSelectedDates(cal, testDt);
	
				cal = null;
			},
	
			testClickSelect: function() {
				var cal = this.createInstance({pagedate:"5/2007", multi_select:true});
				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);
	
				var testDt = [new Date(2007, 4, 13), new Date(2007, 4, 15), new Date(2007, 4, 22)];
	
				var page = Dom.getElementsByClassName("m5", "tbody", cal.oDomContainer);

				var cellOne = Dom.getElementsByClassName("d22", "td", page[0]);
				var cellTwo = Dom.getElementsByClassName("d15", "td", page[0]);
				var cellThree = Dom.getElementsByClassName("d13", "td", page[0]);
	
				UserAction.click(cellOne[0]);
				UserAction.click(cellTwo[0]);
				UserAction.click(cellThree[0]);

				this.assertSelectedDates(cal, testDt);

				if (YAHOO.util.Dom.hasClass(cellOne, cal.Style.CSS_CELL_SELECTED) === false) {
					throw new YAHOO.util.AssertionError("CSS_SELECTED style not set on selected cell");
				}
				if (YAHOO.util.Dom.hasClass(cellTwo, cal.Style.CSS_CELL_SELECTED) === false) {
					throw new YAHOO.util.AssertionError("CSS_SELECTED style not set on selected cell");
				}
				if (YAHOO.util.Dom.hasClass(cellThree, cal.Style.CSS_CELL_SELECTED) === false) {
					throw new YAHOO.util.AssertionError("CSS_SELECTED style not set on selected cell");
				}
	
				cal = null;
			},

			testSelectInsideRange: function() {
				var expectedDt, cal;
				
				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);
				if (grpCal) {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"5/20/2007"});
					expectedDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14), new Date(2007, 4, 10), new Date(2007, 4, 11), new Date(2007, 4, 12)];
				} else {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});
					expectedDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14)];
				}

				cal.selectCell(11); // 4/12, 5/10
				cal.selectCell(12); // 4/13, 5/11
				cal.selectCell(13); // 4/14, 5/12
 
				this.assertSelectedDates(cal, expectedDt);

				cal = null;
			},

			testSelectOverlappingRange: function() {
				var expectedDt, cal;

				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);

				if (grpCal) {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"5/20/2007"});
					expectedDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14), new Date(2007, 4, 10), new Date(2007, 4, 11), new Date(2007, 4, 12)];
				} else {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});
					expectedDt = [new Date(2007, 3, 12), new Date(2007, 3, 13), new Date(2007, 3, 14)];
				}

				cal.selectCell(1);  // 4/2, 4/30
				cal.selectCell(11); // 4/12, 5/10
				cal.selectCell(12); // 4/13, 5/11
				cal.selectCell(13); // 4/14, 5/12
				cal.selectCell(30); // 5/1, 5/29
				cal.selectCell(38); // 5/9, 6/6
 
				this.assertSelectedDates(cal, expectedDt);

				cal = null;
			},
			
			testSelectOutsideRange: function() {
				var expectedDt, cal;

				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);

				if (grpCal) {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"5/20/2007"});
					expectedDt = [];
				} else {
					cal = this.createInstance({pagedate:"4/2007", multi_select:true, mindate:"4/10/2007", maxdate:"4/20/2007"});
					expectedDt = [];
				}

				cal.selectCell(0);  // 4/1, 4/29
				cal.selectCell(1);  // 4/2, 4/30
				cal.selectCell(30); // 5/1, 5/29
				cal.selectCell(35); // 5/6, 6/3
				cal.selectCell(38); // 5/9, 6/6

				this.assertSelectedDates(cal, expectedDt);

				cal = null;
			},
	
			testClickPageNav: function() {
				var cal = this.createInstance({pagedate:"5/2007"});
	
				var grpCal = (this.widgetclass === YAHOO.widget.CalendarGroup);
				
				var prevPage = Dom.getElementsByClassName(cal.Style.CSS_NAV_LEFT, "a", cal.oDomContainer);
				UserAction.mousedown(prevPage[0]);
	
				DateAssert.datesAreSame(new Date(2007, 3, 1), this.getCfgProperty(cal, "pagedate"), "Click on previous page not correct");
	
				var nextPage = Dom.getElementsByClassName(cal.Style.CSS_NAV_RIGHT, "a", cal.oDomContainer);
				UserAction.mousedown(nextPage[0]);
	
				DateAssert.datesAreSame(new Date(2007, 4, 1), this.getCfgProperty(cal, "pagedate"), "Click on next page not correct");
			}
		};

		var cfgTemplate = {
	
			needsUI : false,
	
			testConstruction: function() {
				this._testConstruction();
			},
	
			testDateParsing : function() {
	
				// Case is mixed, to test config case-insensitivity
	
				var opts  = {
					DaTE_DELIMITER:"#",
					DaTE_FIELD_DELIMITER:"-",
					DaTE_RANGE_DELIMITER:"+",
					My_MONTH_PoSITION:2,
					My_YEAR_POsITION:1,
					MdY_MONTH_POSITION:2,
					MdY_DAY_POSITION:3,
					MdY_YEAR_POSITION:1,
					SeLECTED : "1972-2-7#1972-2-14+1972-2-21#1972-2-25",
					PAgeDate : "1972-2"
				};
	
				var cal = this.createInstance(opts);
	
				var testDt = [new Date(1972, 1, 7), new Date(1972, 1, 14), new Date(1972, 1, 15), new Date(1972, 1, 16), new Date(1972, 1, 17), new Date(1972, 1, 18), new Date(1972, 1, 19), new Date(1972, 1, 20), new Date(1972, 1, 21), new Date(1972, 1, 25)];
				var testPgDt = new Date(1972, 1, 1);
					
				DateAssert.datesAreSame(testPgDt, this.getCfgProperty(cal, "pagedate"), "Page date not parsed/set correctly");
				DateAssert.dateArraysAreSame(testDt, cal.getSelectedDates(), "Page date not parsed/set correctly");
			}
		};

		var calApiTemplate = YAHOO.lang.merge(apiTemplate, {widgetclass:YAHOO.widget.Calendar, name:"CALENDAR_API"});
		var calDomTemplate = YAHOO.lang.merge(domTemplate, {widgetclass:YAHOO.widget.Calendar, name:"CALENDAR_DOM"});
		var calCfgTemplate = YAHOO.lang.merge(cfgTemplate, {widgetclass:YAHOO.widget.Calendar, name:"CALENDAR_CFG"});

		var calGrpApiTemplate = YAHOO.lang.merge(apiTemplate, {widgetclass:YAHOO.widget.CalendarGroup, name:"CALENDARGROUP_API"});
		var calGrpDomTemplate = YAHOO.lang.merge(domTemplate, {widgetclass:YAHOO.widget.CalendarGroup, name:"CALENDARGROUP_DOM"});
		var calGrpCfgTemplate = YAHOO.lang.merge(cfgTemplate, {widgetclass:YAHOO.widget.CalendarGroup, name:"CALENDARGROUP_CFG"});

		var tests = {
			"CALENDAR_API" 	: new CalendarTestCase(calApiTemplate),
			"CALENDAR_DOM" 	: new CalendarTestCase(calDomTemplate),
			"CALENDAR_CFG" 	: new CalendarTestCase(calCfgTemplate),
			"CALENDARGROUP_API"	: new CalendarTestCase(calGrpApiTemplate),
			"CALENDARGROUP_DOM"	: new CalendarTestCase(calGrpDomTemplate),
			"CALENDARGROUP_CFG"	: new CalendarTestCase(calGrpCfgTemplate)
		}

		function runTests(){

			var calsuite=new YAHOO.tool.TestSuite("calendarsuite");

			var selections = getTestSelections();
			for (var i = 0; i < selections.length; i++) {
				calsuite.add(tests[selections[i]]);
			}

			testLogger.clearConsole();

			YAHOO.tool.TestRunner.clear();
			YAHOO.tool.TestRunner.add(calsuite);
			YAHOO.tool.TestRunner.run();
		}
		
		function getTestSelections() {
			var sel = [];
			var all = [];
			
			var checkboxes = Dom.getElementsByClassName("testSel", "input", "f");
			for (var i = 0; i < checkboxes.length; i++) {
				if (checkboxes[i].checked) {
					sel.push(checkboxes[i].name.toUpperCase());
				}
				all.push(checkboxes[i].name.toUpperCase());
			}

			if (sel.length > 0) {
				return sel;
			} else {
				return all;
			}
		}
	
		YAHOO.util.Event.addListener(window, "load", function() {
			testLogger = new YAHOO.tool.TestLogger();
			YAHOO.util.Event.addListener("btnRun", "click", runTests);	
		});
	})();
	</script>

</head>
<body>

	<h1>Calendar Tests</h1>
	<p>The YUI Calendar Suite is split into 6 test cases. The three types of test case below are created for both Calendar and CalendarGroup:</p>
	
	<form name="f" id="f">
		<ol class="testlist">
			<li><strong>API Tests:</strong> These tests are intended to test the API, without going through the DOM Element or Event layers
				<ul>
					<li><input type="checkbox" name="CALENDAR_API" class="testSel" /> Calendar API <span class="testname">(CALENDAR_API)</span></li>
					<li><input type="checkbox" name="CALENDARGROUP_API" class="testSel" /> CalendarGroup API <span class="testname">(CALENDARGROUP_API)</span></li>
				</ul>
			</li>
			<li><strong>DOM Tests:</strong> These tests are intended to test the DOM Element and Event layers
				<ul>
					<li><input type="checkbox" name="CALENDAR_DOM" class="testSel" /> Calendar DOM <span class="testname">(CALENDAR_DOM)</span></li>
					<li><input type="checkbox" name="CALENDARGROUP_DOM" class="testSel" /> CalendarGroup DOM <span class="testname">(CALENDARGROUP_DOM)</span></li>
				</ul>
			</li>
			<li><strong>CFG Tests:</strong> These tests are intended to test the set of Calendar configuration properties
				<ul>
					<li><input type="checkbox" name="CALENDAR_CFG" class="testSel" /> Calendar Config <span class="testname">(CALENDAR_CFG)</span></li>
					<li><input type="checkbox" name="CALENDARGROUP_CFG" class="testSel" /> CalendarGroup Config <span class="testname">(CALENDARGROUP_CFG)</span></li>
				</ul>
			</li>
		</ol>
	</form>
	
	<p><input type="button" value="Run Tests" id="btnRun" /></p>

</body>
</html>
