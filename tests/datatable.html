<html>
<head>
<title>YUI DataTable Tests</title>
<link type="text/css" rel="stylesheet" href="../build/logger/assets/skins/sam/logger.css" />
<link type="text/css" rel="stylesheet" href="../build/yuitest/assets/testlogger.css" />
<link type="text/css" rel="stylesheet" href="../build/datatable/assets/skins/sam/datatable.css" />
<style type="text/css">
.yui-skin-sam .yui-log .yui-log-bd {height:60em;margin-top:2em;}
</style>

<script type="text/javascript" src="../build/yahoo/yahoo-min.js"></script>
<script type="text/javascript" src="../build/dom/dom-min.js"></script>
<script type="text/javascript" src="../build/event/event-min.js"></script>
<script type="text/javascript" src="../build/logger/logger-min.js"></script>
<script type="text/javascript" src="../build/yuitest/yuitest-beta.js"></script>
<script type="text/javascript" src="../build/element/element-beta-min.js"></script>
<script type="text/javascript" src="../build/datasource/datasource-beta-min.js"></script>
<script type="text/javascript" src="../build/datatable/datatable-beta-min.js"></script>

</head>
<body class="yui-skin-sam">
<h1>DataTable Tests</h1>
<p><input type="button" value="Run Tests" id="btnRun" disabled="true" /></p>

<script type="text/javascript">

(function() {

    var gCount = -1;

    var Dom=YAHOO.util.Dom,
        Assert=YAHOO.util.Assert,
        ObjectAssert=YAHOO.util.ObjectAssert,
        ArrayAssert=YAHOO.util.ArrayAssert,
        DateAssert=YAHOO.util.DateAssert,
        UserAction=YAHOO.util.UserAction,
        TestCase = YAHOO.tool.TestCase,
        TestLogger = YAHOO.tool.TestLogger,
        TestRunner = YAHOO.tool.TestRunner,
        TestSuite = YAHOO.tool.TestSuite,

        DataSource = YAHOO.util.DataSource,
        DataTable = YAHOO.widget.DataTable,
        ColumnSet = YAHOO.widget.ColumnSet,
        RecordSet = YAHOO.widget.RecordSet;

    var TableAssert = {
        areSameRow: function(exp, act, msg) {
            Assert.areSame("tr", act.tagName.toLowerCase(), "Expected a TR element: " + msg);
            Assert.areSame(exp.id, act.id, "Unexpected DOM ID: " + msg);
            Assert.areSame(exp.sectionRowIndex, act.sectionRowIndex, "Unexpected sectionRowIndex: " + msg);
            Assert.areSame(exp.yuiRecordId, act.yuiRecordId, "Unexpected Record ID: " + msg);
        },
        
        areSameCell: function(exp, act, msg) {
            Assert.areSame("td", act.tagName.toLowerCase(), "Expected a TD element: " + msg);
            Assert.areSame(exp.id, act.id, "Unexpected DOM ID: " + msg);
            Assert.areSame(exp.yuiCellIndex, act.yuiCellIndex, "Unexpected yuiCellIndex: " + msg);
            Assert.areSame(exp.yuiColumnKey, act.yuiColumnKey, "Unexpected Column Key: " + msg);
        }
    };

    function DataTableTestCase(template) {
        DataTableTestCase.superclass.constructor.call(this, template);
    };
    YAHOO.lang.extend(DataTableTestCase, TestCase);

    DataTableTestCase.prototype.setUp = function() {
        this.container = document.createElement("div");
        this.container.id = "testDTContainer";
        document.body.appendChild(this.container);
        
        this.datasource = new YAHOO.util.DataSource(this.data, this.dsConfig);
    };

    DataTableTestCase.prototype.tearDown = function() {
        this.datatable.destroy();
        this.datatable = null;
        
        if (this.container != null) {
            YAHOO.util.Event.purgeElement(this.container, true);
            document.body.removeChild(this.container);
        }
        
        this.datasource = null;
    };

    DataTableTestCase.prototype.createInstance = function(oConfig) {
        this.datatable = new DataTable(this.container, this.columns, this.datasource, oConfig);
        gCount++;
        return this.datatable;
    };

    var dtBaseTemplate = {
        name: "DataTable Base Test Case",
        
        data: [
            {a:"0a",b:"0b",c:"0c"},
            {a:"1a",b:"1b",c:"1c"},
            {a:"2a",b:"2b",c:"2c"},
            {a:"3a",b:"3b",c:"3c"}
        ],
            
        dsConfig: {
            responseType:YAHOO.util.DataSource.TYPE_JSARRAY,
            responseSchema:{fields:["a","b","c"]}
        },

        columns: [{key:"a"},{key:"b"},{key:"c"}],

        testConstruction: function() {
            var dt = this.createInstance();
            
            Assert.isObject(dt, "Failed to create DataTable instance");
            Assert.isInstanceOf(DataTable, dt, "Failed to create DataTable instance");
            Assert.isInstanceOf(ColumnSet, dt.getColumnSet(), "Failed to create ColumnSet instance");
            Assert.isInstanceOf(RecordSet, dt.getRecordSet(), "Failed to create RecordSet instance");
            Assert.areSame(this.data.length, dt.getRecordSet().getLength(), "Unexpected RecordSet length");
        }
    };
    
    /**
     *
     *
     * Tests various construction use cases.
     *
     *
     */
    var dtConstructionTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Construction Test Case",

        testNestedHeaders: function() {
            /* TODO */
            var dt = this.createInstance();
        },
        
        testMultipleInstances: function() {
            var multiple = 3; // Set how many instances (total) to create for this test case
            
            // Create first instance
            var dt = this.createInstance();
            var cs = dt.getColumnSet();
            var oColumn = cs.keys[0];
            var sColId = oColumn.getId();

            // Create the other instances
            for(var i=1; i<multiple; i++) {
                this["container"+i] = document.createElement("div");
                this["container"+i].id = "testDTContainer"+i;
                document.body.appendChild(this["container"+i]);

                this["datasource"+i] = new YAHOO.util.DataSource(this.data, this.dsConfig);
                
                this["dt"+i] = new YAHOO.widget.DataTable(this["container"+i], this.columns, this["datasource"+i]);
                this["cs"+i] = this["dt"+i].getColumnSet();
                gCount++;
            }
            
            // Test getColumn() on first instance
            var el = dt.getTheadEl().rows[0].cells[0];
            var oTestColumn = dt.getColumn(el);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by el reference");

            el = Dom.get(dt.id+"-col"+sColId);
            oTestColumn = dt.getColumn(el);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by DOM ID");

            oTestColumn = dt.getColumn(0);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key index");

            oTestColumn = cs.getColumn("a");
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key");

            oTestColumn = cs.getColumnById(sColId);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by Column ID");
            
            // Test getColumn() on other instances
            for(var i=1; i<multiple; i++) {
                oColumn = this["cs"+i].keys[0];
                sColId = oColumn.getId();
                
                el = this["dt"+i].getTheadEl().rows[0].cells[0];
                oTestColumn = this["dt"+i].getColumn(el);
                Assert.areSame(oColumn, oTestColumn, "Expected to get Column by el reference");

                el = Dom.get(this["dt"+i].id+"-col"+sColId);
                oTestColumn = this["dt"+i].getColumn(el);
                Assert.areSame(oColumn, oTestColumn, "Expected to get Column by DOM ID");

                oTestColumn = this["dt"+i].getColumn(0);
                Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key index");

                oTestColumn = this["cs"+i].getColumn("a");
                Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key");

                oTestColumn = this["cs"+i].getColumnById(sColId);
                Assert.areSame(oColumn, oTestColumn, "Expected to get Column by Column ID");
            }

            // Destroy the other instances (first instance gets destroyed by the tearDown() function)
            for(var i=1; i<3; i++) {
                this["dt"+i].destroy();
                this["dt"+i] = null;

                if (this["container"+i] != null) {
                    YAHOO.util.Event.purgeElement(this["container"+i], true);
                    document.body.removeChild(this["container"+i]);
                }

                this.datasource = null;
            }
        }
    });
    var dtConstructionTest = new DataTableTestCase(dtConstructionTemplate)

    /**
     *
     *
     * Tests DOM element getters.
     *
     *
     */
    var dtDomAccessorsTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable DOM Accessors Test Case",

        testGetTableEl: function() {
            var dt = this.createInstance();
            var elTable = dt.getTableEl();
            
            Assert.areSame("table", elTable.tagName.toLowerCase(), "Expected a TABLE element");
            Assert.areSame(dt.id+"-table", elTable.id, "Failed to generate correct TABLE DOM ID");
        },

        testGetMsgTbodyEl: function() {
            var dt = this.createInstance();
            var elTable = dt.getTableEl();
            var elTbody = dt.getMsgTbodyEl();
            
            Assert.areSame("tbody", elTbody.tagName.toLowerCase(), "Expected a TBODY element");
            //TODO: generate ID for tbody?
            //Assert.areSame(dt.id+"-tbody", elTbody.id, "Failed to generate correct TBODY DOM ID");
            Assert.areSame(elTable.tBodies[0], elTbody, "Expected to get first TBODY element of the TABLE");
        },

        testGetTbodyEl: function() {
            var dt = this.createInstance();
            var elTable = dt.getTableEl();
            var elTbody = dt.getTbodyEl();
            
            Assert.areSame("tbody", elTbody.tagName.toLowerCase(), "Expected a TBODY element");
            //TODO: generate ID for tbody?
            //Assert.areSame(dt.id+"-tbody", elTbody.id, "Failed to generate correct TBODY DOM ID");
            Assert.areSame(elTable.tBodies[1], elTbody, "Expected to get second TBODY element of the TABLE");
        },

        testGetFirstTrEl: function() {
            var dt = this.createInstance();
            var elRow = dt.getFirstTrEl();
            
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow0",
                sectionRowIndex:0,
                yuiRecordId:"0"},
                elRow, "Failed to get first row");
        },

        testGetLastTrEl: function() {
            var dt = this.createInstance();
            var elRow = dt.getLastTrEl();
            
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:3,
                yuiRecordId:"3"},
                elRow, "Failed to get last row");
        }
    });
    var dtDomAccessorsTest = new DataTableTestCase(dtDomAccessorsTemplate);

    /**
     *
     *
     * Tests RecordSet APIs.
     *
     *
     */
    var dtRecordSetTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable RecordSet Test Case",

        testGetRecordSet: function() {
            var dt = this.createInstance();
            var rs = dt.getRecordSet();

            Assert.isInstanceOf(RecordSet, rs, "Expected a RecordSet");
        },
        
        testUpdateKey: function() {
            var dt = this.createInstance();
            var rs = dt.getRecordSet();
            var newData = {a:"4a",b:"4b",c:"4c"};
            rs.updateKey(0, "a", newData.a);
            rs.updateKey(0, "b", newData.b);
            rs.updateKey(0, "c", newData.c);

            var oData = dt.getRecord(0).getData();
            Assert.areSame(newData.a, oData.a, "Failed to update key a");
            Assert.areSame(newData.b, oData.b, "Failed to update key b");
            Assert.areSame(newData.c, oData.c, "Failed to update key c");
        }


        //TODO: RecordSet APIs
    });
    var dtRecordSetTest = new DataTableTestCase(dtRecordSetTemplate);

    /**
     *
     *
     * Tests ColumnSet APIs.
     *
     *
     */
    var dtColumnSetTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable ColumnSet Test Case",

        testGetColumnSet: function() {
            var dt = this.createInstance();
            var cs = dt.getColumnSet();

            Assert.isInstanceOf(ColumnSet, cs, "Expected a ColumnSet");
        },
        
        testGetColumn: function() {
            var dt = this.createInstance();
            var cs = dt.getColumnSet();
            var oColumn = cs.keys[0];
            var sColId = oColumn.getId();
            
            var el = dt.getTheadEl().rows[0].cells[0];
            var oTestColumn = dt.getColumn(el);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by el reference");
            
            el = Dom.get(dt.id+"-col"+sColId);
            oTestColumn = dt.getColumn(el);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by DOM ID");
            
            oTestColumn = dt.getColumn(0);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key index");

            oTestColumn = cs.getColumn("a");
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by key");

            oTestColumn = cs.getColumnById(sColId);
            Assert.areSame(oColumn, oTestColumn, "Expected to get Column by Column ID");
        }

        //TODO: ColumnSet APIs
    });
    var dtColumnSetTest = new DataTableTestCase(dtColumnSetTemplate);

    /**
     *
     *
     * Tests row mutation APIs.
     *
     *
     */
    var dtRowMutationTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Row Mutation Test Case",
        testInsertRow: function() {
            var dt = this.createInstance();
            dt.addRow({a:"4a",b:"4b",c:"4c"}, 0);
            
            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:0,
                yuiRecordId:"4"},
                elRow, "Failed to get inserted row");
        },
        
        testAppendRow: function() {
            var dt = this.createInstance();
            dt.addRow({a:"4a",b:"4b",c:"4c"});
            
            var elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:4,
                yuiRecordId:"4"},
                elRow, "Failed to get appended row");
        },

        testUpdateRow: function() {
            var dt = this.createInstance();
            var newData = {a:"4a",b:"4b",c:"4c"};
            dt.updateRow(0, newData);
            
            var oData = dt.getRecord(0).getData();
            Assert.areSame(newData, oData, "Failed to update by Record index");

            newData = {a:"5a",b:"5b",c:"5c"};
            dt.updateRow(dt.getRecord(0), newData);

            oData = dt.getRecord(0).getData();
            Assert.areSame(newData, oData, "Failed to update by Record instance");
            
            newData = {a:"6a",b:"6b",c:"6c"};
            dt.updateRow(dt.id+"-bdrow"+0, newData);

            oData = dt.getRecord(0).getData();
            Assert.areSame(newData, oData, "Failed to update by TR el ID");

            newData = {a:"7a",b:"7b",c:"7c"};
            dt.updateRow(Dom.get(dt.id+"-bdrow"+0), newData);

            oData = dt.getRecord(0).getData();
            Assert.areSame(newData, oData, "Failed to update by TR el reference");
        },

        testDeleteFirstRow: function() {
            var dt = this.createInstance();
            dt.deleteRow(dt.getFirstTrEl());
            
            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+1,
                sectionRowIndex:0,
                yuiRecordId:"1"},
                elRow, "Failed to get new first row");
        },

        testDeleteAppendThenInsert: function() {
            var dt = this.createInstance();
            dt.deleteRow(dt.getFirstTrEl());
            dt.addRow({a:"4a",b:"4b",c:"4c"});
            dt.addRow({a:"5a",b:"5b",c:"5c"},0);

            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+5,
                sectionRowIndex:0,
                yuiRecordId:"5"},
                elRow, "Failed to get first row");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:4,
                yuiRecordId:"4"},
                elRow, "Failed to get last row");
        },

        testDeleteRows: function() {
            var dt = this.createInstance();
            dt.deleteRow(0);
            var nRecordsLength = dt.getRecordSet().getLength();
            var nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(3, nRecordsLength, "Expected 3 Records left");
            Assert.areSame(3, nTrElsLength, "Expected 3 TR els left");

            dt.deleteRow(0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(2, nRecordsLength, "Expected 2 Records left");
            Assert.areSame(2, nTrElsLength, "Expected 2 TR els left");

            dt.deleteRow(0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(1, nRecordsLength, "Expected 1 Records left");
            Assert.areSame(1, nTrElsLength, "Expected 1 TR els left");

            dt.deleteRow(0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(0, nRecordsLength, "Expected 0 Records left");
            Assert.areSame(0, nTrElsLength, "Expected 0 TR els left");
            Assert.areSame("", dt.getMsgTbodyEl().rows[0].cells[0].style.display, "Expected message displayed");
            Assert.areSame(true, Dom.hasClass(dt.getMsgTbodyEl().rows[0].cells[0], "yui-dt-empty"), "Expected empty message");
        },

        testDeleteRowsInReverse: function() {
            var dt = this.createInstance();
            dt.deleteRow(3);
            var nRecordsLength = dt.getRecordSet().getLength();
            var nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(3, nRecordsLength, "Expected 3 Records left");
            Assert.areSame(3, nTrElsLength, "Expected 3 TR els left");

            dt.deleteRow(2);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(2, nRecordsLength, "Expected 2 Records left");
            Assert.areSame(2, nTrElsLength, "Expected 2 TR els left");

            dt.deleteRow(1);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(1, nRecordsLength, "Expected 1 Records left");
            Assert.areSame(1, nTrElsLength, "Expected 1 TR els left");

            dt.deleteRow(0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;

            Assert.areSame(0, nRecordsLength, "Expected 0 Records left");
            Assert.areSame(0, nTrElsLength, "Expected 0 TR els left");
            Assert.areSame("", dt.getMsgTbodyEl().rows[0].cells[0].style.display, "Expected message displayed");
            Assert.areSame(true, Dom.hasClass(dt.getMsgTbodyEl().rows[0].cells[0], "yui-dt-empty"), "Expected empty message");
        },

        testDeleteThenInsertRows: function() {
            var dt = this.createInstance();
            dt.deleteRow(0);
            dt.deleteRow(0);
            dt.deleteRow(0);
            dt.deleteRow(0);

            dt.addRow({a:"4a",b:"4b",c:"4c"}, 0);
            var nRecordsLength = dt.getRecordSet().getLength();
            var nTrElsLength = dt.getTbodyEl().rows.length;
            var oRecord = dt.getRecord(dt.getFirstTrEl());

            Assert.areSame(1, nRecordsLength, "Expected 1 Record");
            Assert.areSame("4", oRecord.getId(), "Expected Record ID 4");
            Assert.areSame(1, nTrElsLength, "Expected 1 TR el");

            dt.addRow({a:"5a",b:"5b",c:"5c"}, 0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;
            oRecord = dt.getRecord(dt.getFirstTrEl());

            Assert.areSame(2, nRecordsLength, "Expected 2 Records");
            Assert.areSame("5", oRecord.getId(), "Expected Record ID 5");
            Assert.areSame(2, nTrElsLength, "Expected 2 TR els");

            dt.addRow({a:"6a",b:"6b",c:"6c"}, 0);
            nRecordsLength = dt.getRecordSet().getLength();
            nTrElsLength = dt.getTbodyEl().rows.length;
            oRecord = dt.getRecord(dt.getFirstTrEl());

            Assert.areSame(3, nRecordsLength, "Expected 3 Records");
            Assert.areSame("6", oRecord.getId(), "Expected Record ID 6");
            Assert.areSame(3, nTrElsLength, "Expected 3 TR els");
        },

        testDeleteInsertThenSortRows: function() {
            var dt = this.createInstance();
            dt.deleteRow(0);
            dt.deleteRow(0);
            dt.deleteRow(0);
            dt.deleteRow(0);

            dt.addRow({a:"4a",b:"4b",c:"4c"}, 0);
            dt.addRow({a:"5a",b:"5b",c:"5c"}, 0);
            dt.addRow({a:"6a",b:"6b",c:"6c"}, 0);
            dt.sortColumn(dt.getColumn(0));
            var elRow = dt.getFirstTrEl();

            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+6,
                sectionRowIndex:0,
                yuiRecordId:"4"},
                elRow, "Failed to get sorted first row");

        }
    });
    var dtRowMutationTest = new DataTableTestCase(dtRowMutationTemplate);

    /**
     *
     *
     * Tests sorting APIs.
     *
     *
     */
    var dtSortingTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Sorting Test Case",
        
        data: [
            {a:0,b:"zero"},
            {a:1,b:"one"},
            {a:2,b:"two"},
            {a:3,b:"three"}
        ],
            
        dsConfig: {
            responseType:YAHOO.util.DataSource.TYPE_JSARRAY,
            responseSchema:{fields:["a","b"]}
        },

        columns: [
            {key:"a",label:"numbers",sortable:true},
            {key:"b",label:"strings",sortable:true}
        ],

        testSortByElementClick: function() {
            var dt = this.createInstance();
            var whichCol = 1;
            var oColumn = dt.getColumn(1);
            var el = dt.getThEl(oColumn);
            UserAction.click(el);
            var elRow = dt.getFirstTrEl();
            
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"1"},
                elRow, "Failed to get first row ascending strings");
            Assert.areSame("one", dt.getRecord(dt.getFirstTrEl()).getData("b"), "Expected first data to be \"one\"");

            el = Dom.get(dt.id+"-container"+oColumn.getId());
            UserAction.click(el);
            elRow = dt.getFirstTrEl();
            
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"0"},
                elRow, "Failed to get first row descending strings");
            Assert.areSame("zero", dt.getRecord(dt.getFirstTrEl()).getData("b"), "Expected first data to be \"zero\"");

            el = Dom.get(dt.id+"-label"+oColumn.getId());
            UserAction.click(el);
            elRow = dt.getFirstTrEl();
            
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"1"},
                elRow, "Failed to get first row ascending strings");
            Assert.areSame("one", dt.getRecord(dt.getFirstTrEl()).getData("b"), "Expected first data to be \"one\" again");

        },

        testSortNumber: function() {
            var dt = this.createInstance();
            // Workaround for bug 1389418
            // var oColumn = dt.getColumn(0);
            var oColumn = dt.getColumn(dt.getFirstTrEl().cells[0].yuiColumnKey);
            dt.sortColumn(oColumn);
            
            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"0"},
                elRow, "Failed to get first row ascending numbers");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:3,
                yuiRecordId:"3"},
                elRow, "Failed to get last row ascending numbers");

            dt.sortColumn(oColumn);
            elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"3"},
                elRow, "Failed to get first row descending numbers");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:3,
                yuiRecordId:"0"},
                elRow, "Failed to get last row descending numbers");
        },

        testSortString: function() {
            var dt = this.createInstance();
            // Workaround for bug 1389418
            // var oColumn = dt.getColumn(1);
            var oColumn = dt.getColumn(dt.getFirstTrEl().cells[1].yuiColumnKey);
            dt.sortColumn(oColumn);

            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"1"},
                elRow, "Failed to get first row ascending strings");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:3,
                yuiRecordId:"0"},
                elRow, "Failed to get last row ascending strings");

            dt.sortColumn(oColumn);
            
            elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"0"},
                elRow, "Failed to get first row descending strings");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:3,
                yuiRecordId:"1"},
                elRow, "Failed to get last row descending strings");
        },

        testInsertThenSort: function() {
            var dt = this.createInstance();
            // Workaround for bug 1389418
            // var oColumn = dt.getColumn(1);
            var oColumn = dt.getColumn(dt.getFirstTrEl().cells[1].yuiColumnKey);

            dt.addRow({a:4,b:"four"}, 0)
            dt.sortColumn(oColumn);
            
            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:0,
                yuiRecordId:"4"},
                elRow, "Failed to get first row ascending strings");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+3,
                sectionRowIndex:4,
                yuiRecordId:"0"},
                elRow, "Failed to get last row ascending strings");
                
            //TODO: test descending
        },
        
        testSortThenAppend: function() {
            var dt = this.createInstance();
            // Workaround for bug 1389418
            // var oColumn = dt.getColumn(1);
            var oColumn = dt.getColumn(dt.getFirstTrEl().cells[1].yuiColumnKey);
            dt.sortColumn(oColumn);
            dt.addRow({a:4,b:"four"});

            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"1"},
                elRow, "Failed to get first row ascending strings");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:4,
                yuiRecordId:"4"},
                elRow, "Failed to get last row ascending strings");
        },
        
        testDeleteAppendInsertThenSort: function() {
            var dt = this.createInstance();

            dt.deleteRow(dt.getFirstTrEl());
            dt.addRow({a:4,b:"four"});
            dt.addRow({a:5,b:"five"},0);
            var oColumn = dt.getColumn(dt.getFirstTrEl().cells[1].yuiColumnKey);
            dt.sortColumn(oColumn);

            var elRow = dt.getFirstTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+5,
                sectionRowIndex:0,
                yuiRecordId:"5"},
                elRow, "Failed to get first row ascending strings");

            elRow = dt.getLastTrEl();
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:4,
                yuiRecordId:"2"},
                elRow, "Failed to get last row ascending strings");

        }
    });
    var dtSortingTest = new DataTableTestCase(dtSortingTemplate);
    
    /**
     *
     *
     * Tests row selection APIs.
     *
     *
     */
    var dtRowSelectionTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Row Selection Test Case",

        testSelectUnselectByEl: function() {
            var dt = this.createInstance();
            var elRow = dt.getFirstTrEl();
            dt.selectRow(elRow);
            var aSelectedRows = dt.getSelectedRows();

            Assert.areSame(true, YAHOO.util.Dom.hasClass(elRow, "yui-dt-selected"), "Failed to apply CSS");
            ArrayAssert.contains(elRow.yuiRecordId, aSelectedRows, "Failed to select first row");
            
            dt.unselectRow(elRow);
            aSelectedRows = dt.getSelectedRows();

            Assert.areSame(false, YAHOO.util.Dom.hasClass(elRow, "yui-dt-selected"), "Failed to remove CSS");
            ArrayAssert.doesNotContain(elRow.yuiRecordId, aSelectedRows, "Failed to unselect first row");

        },
        
        testSelectThenInsert: function() {
            var dt = this.createInstance();
            var elRow = dt.getFirstTrEl();
            dt.selectRow(elRow);
            dt.addRow({a:"4a",b:"4b",c:"4c"}, 0);
            var aSelectedRows = dt.getSelectedRows();
            
            elRow = dt.getTbodyEl().rows[1];

            Assert.areSame(true, YAHOO.util.Dom.hasClass(elRow, "yui-dt-selected"), "Failed to apply CSS");
            ArrayAssert.contains(elRow.yuiRecordId, aSelectedRows, "Second row should be selected");

            elRow = dt.getTbodyEl().rows[0];

            Assert.areSame(false, YAHOO.util.Dom.hasClass(elRow, "yui-dt-selected"), "Failed to apply CSS");
            ArrayAssert.doesNotContain(elRow.yuiRecordId, aSelectedRows, "First row should not be selected");
        },
        
        testSingleSelect: function() {
            var oConfig = {
                selectionMode:"single"
            }
            var dt = this.createInstance(oConfig);
            dt.subscribe("rowClickEvent",dt.onEventSelectRow,dt);

            var el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el);
            var aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["0"], aSelectedRows, "Expected first row selected");
            var aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([el], aSelectedEls, "Expected only first TR el selected");

            el = Dom.get(dt.id+"-bdrow1");
            UserAction.click(el);
            el = Dom.get(dt.id+"-bdrow2");
            UserAction.click(el);
            el = Dom.get(dt.id+"-bdrow3");
            UserAction.click(el);
            aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["3"], aSelectedRows, "Expected fourth row selected");
            aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([el], aSelectedEls, "Expected fourth TR el selected");
        },
        
        testShiftSelect: function() {
            var dt = this.createInstance();
            dt.subscribe("rowClickEvent",dt.onEventSelectRow,dt);

            var el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el);
            el = Dom.get(dt.id+"-bdrow3");
            UserAction.click(el, {"shiftKey":true});
            aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["0","1","2","3"], aSelectedRows, "Expected four rows selected");
            var aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame(
                [Dom.get(dt.id+"-bdrow0"),Dom.get(dt.id+"-bdrow1"),Dom.get(dt.id+"-bdrow2"),Dom.get(dt.id+"-bdrow3")],
                aSelectedEls, "Expected four TR els selected");

            el = Dom.get(dt.id+"-bdrow2");
            UserAction.click(el);
            aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["2"], aSelectedRows, "Expected only third row selected");
            aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([el], aSelectedEls, "Expected only third TR el selected");

            el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el, {"shiftKey":true});
            aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["2","1","0"], aSelectedRows, "Expected three rows selected");
            aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame(
                [el, Dom.get(dt.id+"-bdrow1"), Dom.get(dt.id+"-bdrow2")],
                aSelectedEls, "Expected three TR els selected");
        }
    });
    var dtRowSelectionTest = new DataTableTestCase(dtRowSelectionTemplate);

    /**
     *
     *
     * Tests cell selection APIs.
     *
     *
     */
    var dtCellSelectionTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Row Selection Test Case"
    });
    var dtCellSelectionTest = new DataTableTestCase(dtCellSelectionTemplate);
    
    /**
     *
     *
     * Tests pagination APIs.
     *
     *
     */
    var dtPaginationTemplate = YAHOO.lang.merge(dtBaseTemplate, {
        name: "DataTable Pagination Test Case",
        
        data: [
            {a:0},{a:1},{a:2},{a:3},{a:4},
            {a:5},{a:6},{a:7},{a:8},{a:9},
            {a:10},{a:11},{a:12},{a:13},{a:14},
            {a:15},{a:16},{a:17},{a:18},{a:19},
            {a:20},{a:21}
        ],

        dsConfig: {
            responseType:YAHOO.util.DataSource.TYPE_JSARRAY,
            responseSchema:{fields:["a"]}
        },

        columns: [{key:"a", sortable:true}],

        testPagination: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5}
            }
            var dt = this.createInstance(oConfig);
            Assert.areSame(5, dt.get("paginator").totalPages, "Expected 5 pages");
        },

        testPageThenSort: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5},
                sortedBy: {key:"a"}
            }
            var dt = this.createInstance(oConfig);
            dt.showPage(2);
            dt.sortColumn(dt.getColumn("a"));
            Assert.areSame(1, dt.get("paginator").currentPage, "Expected to be on page 1");
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+0,
                sectionRowIndex:0,
                yuiRecordId:"21"},
                dt.getFirstTrEl(), "Expected first row in descending order");
            TableAssert.areSameRow(
                {id:dt.id+"-bdrow"+4,
                sectionRowIndex:4,
                yuiRecordId:"17"},
                dt.getLastTrEl(), "Expected last row first page in descending order");
        },

        testDeleteRowsCurrentPage: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5}
            }
            var dt = this.createInstance(oConfig);
            dt.deleteRows(0,2);
            // Workaround bug 1391828
            dt.refreshView();
            Assert.areSame(4, dt.get("paginator").totalPages, "Expected 4 pages");
        },
        
         testDeleteRowsDifferentPage: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5}
            }
            var dt = this.createInstance(oConfig);
            dt.showPage(5);
            dt.deleteRows(0,2);
            // Workaround bug 1391828
            dt.refreshView();
            Assert.areSame(4, dt.get("paginator").totalPages, "Expected 4 pages");
            Assert.areSame(4, dt.get("paginator").currentPage, "Expected to be on page 4");
        },
        
        testSingleSelectAcrossPages: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5},
                selectionMode:"single"
            }
            var dt = this.createInstance(oConfig);
            dt.subscribe("rowClickEvent",dt.onEventSelectRow,dt);

            var el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el);
            dt.showPage(5);
            // Workaround bug 1391828
            dt.refreshView();
            el = Dom.get(dt.id+"-bdrow1");
            UserAction.click(el);
            var aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["21"], aSelectedRows, "Expected only second row of last page (Record \"21\") selected");
            var aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([el], aSelectedEls, "Expected only second TR el selected");
        },
        
        testShiftSelectAcrossPages: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5},
                selectionMode:"standard"
            }
            var dt = this.createInstance(oConfig);
            dt.subscribe("rowClickEvent",dt.onEventSelectRow,dt);

            var el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el);
            dt.showPage(2);
            el = Dom.get(dt.id+"-bdrow1");
            UserAction.click(el, {"shiftKey":true});
            var aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["0","1","2","3","4","5","6"], aSelectedRows, "Expected seven rows across two pages selected");
            var aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([Dom.get(dt.id+"-bdrow0"), Dom.get(dt.id+"-bdrow1")], aSelectedEls, "Expected first two TR els selected");

            el = Dom.get(dt.id+"-bdrow2");
            UserAction.click(el);
            aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["7"], aSelectedRows, "Expected only third row of second page selected");
            aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([el], aSelectedEls, "Expected only third TR el selected");
        },
        
        testSingleSelectAcrossRowsPerPage: function() {
            var oConfig = {
                paginated:true,
                paginator: {rowsPerPage:5},
                selectionMode:"single"
            }
            var dt = this.createInstance(oConfig);
            dt.subscribe("rowClickEvent",dt.onEventSelectRow,dt);

            var el = Dom.get(dt.id+"-bdrow0");
            UserAction.click(el);
            dt.showPage(2);
            el = Dom.get(dt.id+"-bdrow2");
            UserAction.click(el);
            dt.updatePaginator({rowsPerPage:10, currentPage:1});
            dt.refreshView();
            var aSelectedRows = dt.getSelectedRows();
            ArrayAssert.itemsAreSame(["7"], aSelectedRows, "Expected only one row selected");
            var aSelectedEls = Dom.getElementsByClassName("yui-dt-selected", "*", dt.getTbodyEl());
            ArrayAssert.itemsAreSame([Dom.get(dt.id+"-bdrow7")], aSelectedEls, "Expected seventh TR el selected");
        }
    });
    var dtPaginationTest = new DataTableTestCase(dtPaginationTemplate);

    function runTests(){
        TestRunner.run();
    }

    YAHOO.util.Event.addListener(window, "load", function() {
        var logger = new TestLogger();
        var datatablesuite = new TestSuite("DataTable Test Suite");
        datatablesuite.add(dtConstructionTest);
        datatablesuite.add(dtDomAccessorsTest);
        datatablesuite.add(dtRecordSetTest);
        datatablesuite.add(dtColumnSetTest);
        datatablesuite.add(dtRowMutationTest);
        datatablesuite.add(dtSortingTest);
        datatablesuite.add(dtRowSelectionTest);
        datatablesuite.add(dtCellSelectionTest);
        datatablesuite.add(dtPaginationTest);
        
        TestRunner.add(datatablesuite);

        YAHOO.util.Event.addListener("btnRun", "click", runTests);
        YAHOO.util.Dom.get("btnRun").disabled = false;

        if (parent && parent != window) {
            YAHOO.tool.TestManager.load();
        }
    });
})();

</script>
</body>
</html>
