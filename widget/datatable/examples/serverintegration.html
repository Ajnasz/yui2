<!doctype html public "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Example: DataTable - Server-side Sorting and Pagination (with BHM Integration)(YUI Library)</title>
<link type="text/css" rel="stylesheet" href="../../build/reset/reset.css">
<link type="text/css" rel="stylesheet" href="../../build/fonts/fonts.css">
<link type="text/css" rel="stylesheet" href="../../build/logger/assets/logger.css">
<link type="text/css" rel="stylesheet" href="../../build/datatable/assets/datatable.css">
<link type="text/css" rel="stylesheet" href="./css/examples.css">
<link type="text/css" rel="stylesheet" href="../assets/dpSyntaxHighlighter.css">
<style type="text/css">
/* custom css*/
#paginated {margin:1em;}
#paginated table {border-collapse:collapse;}
#paginated th, #paginated td {border:1px solid #000;}
#paginated th {background-color:#696969;color:#fff;}/*dark gray*/
#paginated tr.yui-dt-odd {background-color:#eee;} /*light gray*/
</style>
</head>
<body>
<div id="hd">
    <h1><img src="./img/logo.gif" class="logo" alt="Y!"/><a href="./">DataTable Widget</a> :: Server-side Sorting and Pagination (with BHM Integration)</h1>
</div>
<div id="bd">
    <div id="nav">
        <span id="prevLink">&lt;</span> Showing items
        <span id="startIndex">0</span> - <span id="endIndex">24</span>
        <span id="ofTotal"></span> <span id="nextLink">&gt;</span>
    </div>
    <div id="paginated"></div>
    
    <!-- Sample code begins -->
    <div id="code">
        <h3>Sample Code</h3>

        <p>Data:</p>

        <textarea name="code" class="JScript" cols="60" rows="1">
        </textarea>

        <p>CSS:</p>

        <textarea name="code" class="HTML" cols="60" rows="1">
        </textarea>

        <p>Markup:</p>

        <textarea name="code" class="HTML" cols="60" rows="1">
        </textarea>

        <p>JavaScript:</p>

        <textarea name="code" class="JScript" cols="60" rows="1">
        </textarea>
    </div>
    <!-- Code sample ends -->
</div>

<script type="text/javascript" src="./js/json.js"></script>
<script type="text/javascript" src="../../build/yahoo/yahoo.js"></script>
<script type="text/javascript" src="../../build/dom/dom.js"></script>
<script type="text/javascript" src="../../build/event/event.js"></script>
<script type="text/javascript" src="../../build/connection/connection.js"></script>
<script type="text/javascript" src="../../build/element/element-beta.js"></script>
<script type="text/javascript" src="../../build/history/history-experimental.js"></script>
<script type="text/javascript" src="../../build/logger/logger.js"></script>
<script type="text/javascript" src="../../build/datasource/datasource-beta-debug.js"></script>
<script type="text/javascript" src="../../build/datatable/datatable-beta-debug.js"></script>

<script type="text/javascript">
YAHOO.example.ServerIntegration = new function() {
    this.myLogger = new YAHOO.widget.LogReader();
    this.myLogger.collapse();

    /****************************************************************************/
    /****************************************************************************/
    /****************************************************************************/

    // Default values
    this.paginator = {
        sort:"id",
        dir:"asc",
        results:25,
        startIndex:0,
        endIndex:null,
        recordsReturned:null,
        totalResults:null
    };

    // Updates paginator with new values parsed out of hash string
    this.parseState = function(sState) {
        if(sState.length > 0) {
            sState = sState.substring(sState.indexOf("=")+1);
            var aPairs = sState.split("&");
            var tmpHash = {};
            for(var i=0; i<aPairs.length; i++) {
                var sPair = aPairs[i];
                if(sPair.indexOf("=") > 0) {
                    var n = sPair.indexOf("=");
                    sParam = aPairs[i].substring(0,n);
                    sValue = aPairs[i].substring(n+1);
                    tmpHash[sParam] = sValue;
                }
            }
            //sState = decodeURIComponent(tmpHash["mySvrPagDataTable"]);
            // Validate new values
            if((tmpHash["results"] !== undefined) && (tmpHash["results"] !== null)) {
                var newResults = parseInt(tmpHash["results"],10);
                if(YAHOO.lang.isNumber(newResults)) {
                    this.paginator["results"] = newResults;
                }
            }
            if((tmpHash["startIndex"] !== undefined) && (tmpHash["startIndex"] !== null)) {
                var newStart = parseInt(tmpHash["startIndex"],10);
                this.paginator["startIndex"] = newStart;
            }
            if((tmpHash["sort"] !== undefined) && (tmpHash["sort"] !== null)) {
                this.paginator["sort"] = tmpHash["sort"];
            }
            if((tmpHash["dir"] !== undefined) && (tmpHash["dir"] !== null)) {
                this.paginator["dir"] = tmpHash["dir"];
            }
        }
    };

    // Makes a request string out of current paginator values
    this.getState = function() {
        return "results=" + this.paginator["results"] +
        "&startIndex=" + this.paginator["startIndex"] +
        "&sort=" + this.paginator["sort"] +
        "&dir=" + this.paginator["dir"];
    };

    // Makes a request string for next page
    this.getStateNextPage = function() {
        var nextIndex = (this.paginator["startIndex"] + this.paginator["results"]);

        return "results=" + this.paginator["results"] +
        "&startIndex=" + nextIndex +
        "&sort=" + this.paginator["sort"] +
        "&dir=" + this.paginator["dir"];
    };

    // Makes a request string for previous page
    this.getStatePrevPage = function() {
        var prevIndex =
                this.paginator["startIndex"] - this.paginator["results"];
        if(prevIndex < 0) {
            prevIndex = 0;
        }
        return "results=" + this.paginator["results"] +
        "&startIndex=" + prevIndex +
        "&sort=" + this.paginator["sort"] +
        "&dir=" + this.paginator["dir"];
    };
    // Returns a request string of initial paginator values
    // parsing hash string if available, using default values otherwise
    this.getInitialState = function() {
        if(location.hash.substring(1).length > 0) {
            this.parseState(location.hash.substring(1));
        }
        return this.getState();
    };

    // Instantiate myColumnDefs
    var myColumnDefs = [
        {key:"id",text:"ID"},
        {key:"name",text:"Name"},
        {key:"date",text:"Date"},
        {key:"price",text:"Price"},
        {key:"number",text:"Number"},
        {key:"address",text:"Address"},
        {key:"company",text:"Company"},
        {key:"desc",text:"Description"},
        {key:"age",text:"Age"},
        {key:"title",text:"Title"},
        {key:"phone",text:"Phone"},
        {key:"email",text:"Email"},
        {key:"zip",text:"Zip"},
        {key:"country",text:"Country"}
    ];

    // Instantiate DataSource
    this.myDataSource = new YAHOO.util.DataSource("./php/json_proxy.php?");
    this.myDataSource.responseType = YAHOO.util.DataSource.TYPE_JSON;
    this.myDataSource.responseSchema = {
        resultsList: "records",
        fields: ["id","name","date","price","number","address","company","desc","age","title","phone","email","zip","country"]
    };

    // Instantiate DataTable
    var initialState = this.getInitialState();
    var oConfigs = {
        caption:"Example: Server-side Sorting and Pagination (with BHM Integration)",
        initialRequest: initialState
    };
    this.myDataTable = new YAHOO.widget.DataTable("paginated", myColumnDefs,
            this.myDataSource, oConfigs);

    // BHM integration
    this.myBookmarkedState = YAHOO.util.History.getBookmarkedState("mySvrPagDataTable");
    this.myInitialState = this.myBookmarkedState || initialState;
    this.myStateChangeHandler = function(newState) {
        var oSelf = YAHOO.example.ServerIntegration;
        oSelf.myDataSource.sendRequest(newState, oSelf.myDataTable.onDataReturnInitializeTable, oSelf.myDataTable);
    };
    YAHOO.util.History.register("mySvrPagDataTable", this.myInitialState, this.myStateChangeHandler);
    YAHOO.util.History.initialize();

    // Custom UI
    this.myDataSource.doBeforeCallback = function(oRequest, oRawResponse, oParsedResponse) {
        var oSelf = YAHOO.example.ServerIntegration;
        
        var oRawResponse = JSON.parse(oRawResponse);
        var recordsReturned = oRawResponse.recordsReturned;
        var startIndex = oRawResponse.startIndex;
        var endIndex = startIndex + recordsReturned -1;
        var totalRecords = oRawResponse.totalRecords;
        var sort = oRawResponse.sort;
        var dir = oRawResponse.dir;

        oSelf.paginator.recordsReturned = recordsReturned;
        oSelf.paginator.startIndex = startIndex;
        oSelf.paginator.endIndex = endIndex;
        oSelf.paginator.totalResults = totalRecords;
        oSelf.paginator.sort = sort;
        oSelf.paginator.dir = dir;

        var elPrevLink = YAHOO.util.Dom.get("prevLink");
        if(startIndex > 0) {
            elPrevLink.innerHTML = "<a href=\"#" + oSelf.getStatePrevPage() + "\" alt=\"Show previous items\">&lt;</a>";
        }
        else {
            elPrevLink.innerHTML = "&lt;";
        }
        
        var elNextLink = YAHOO.util.Dom.get("nextLink");
        if(endIndex+1 < totalRecords) {
            elNextLink.innerHTML = "<a href=\"#" + oSelf.getStateNextPage() + "\" alt=\"Show next items\">&gt;</a>";
        }
        else {
            elNextLink.innerHTML = "&gt;";
        }
        
        YAHOO.util.Dom.get("startIndex").innerHTML = startIndex;
        YAHOO.util.Dom.get("endIndex").innerHTML = endIndex;
        YAHOO.util.Dom.get("ofTotal").innerHTML = " of " + totalRecords;
        
        return oParsedResponse;
    };
    
    // Custom sorting
    this.sortColumn = function(oArgs, oSelf) {
        var e = oArgs.event;
        YAHOO.util.Event.stopEvent(e);
        
        var elTarget = oArgs.target;
        var oColumn = oSelf.myDataTable.getColumn(elTarget);
        
        // Already sorted
        if(oSelf.paginator["sort"] == oColumn.key) {
            oSelf.paginator["dir"] = (oSelf.paginator["dir"] == "asc") ? "desc" : "asc";
        }
        // Sort ascending
        else {
            oSelf.paginator["sort"] = oColumn.key;
            oSelf.paginator["dir"] = "asc";
        }

        oSelf.paginator["startIndex"] = 0;
        var newState = oSelf.getState();
        YAHOO.util.History.navigate("mySvrPagDataTable", newState);
    };
    this.myDataTable.subscribe("headerLabelClickEvent", this.sortColumn, this);

    // Custom pagination
    this.getPreviousPage = function(e) {
        YAHOO.util.Event.stopEvent(e);
        if(this.paginator["startIndex"] === 0) {
            return;
        }
        this.paginator["startIndex"] =
                this.paginator["startIndex"] - this.paginator["results"];
        if(this.paginator["startIndex"] < 0) {
            this.paginator["startIndex"] = 0;
        }
        var newState = this.getState();
        YAHOO.util.History.navigate("mySvrPagDataTable", newState);
    };
    this.getNextPage = function(e) {
        YAHOO.util.Event.stopEvent(e);
        if(this.paginator["startIndex"] + this.paginator["results"] >= this.paginator["totalResults"]) {
            return;
        }
        this.paginator["startIndex"] = (this.paginator["startIndex"] + this.paginator["results"]);
        var newState = this.getState();
        YAHOO.util.History.navigate("mySvrPagDataTable", newState);
    };
    YAHOO.util.Event.addListener(YAHOO.util.Dom.get("prevLink"), "click", this.getPreviousPage, this, true);
    YAHOO.util.Event.addListener(YAHOO.util.Dom.get("nextLink"), "click", this.getNextPage, this, true);
};
</script>
<script type="text/javascript" src="../assets/dpSyntaxHighlighter.js"></script>
<script type="text/javascript">
dp.SyntaxHighlighter.HighlightAll('code');
</script>
</body>
</html>
