<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>

		<link type="text/css" rel="stylesheet" href="../../../build/fonts/fonts.css">
		<link type="text/css" rel="stylesheet" href="../../../build/reset/reset.css">
		
		<script type="text/javascript" src="../../../build/yahoo/yahoo.js"></script>
		<script type="text/javascript" src="../../../build/event/event.js" ></script>
		<script type="text/javascript" src="../../../build/dom/dom.js" ></script>
		<script type="text/javascript" src="../../../build/animation/animation.js" ></script>
		<script type="text/javascript" src="../../../build/connection/connection.js" ></script>

		<script type="text/javascript" src="../../../build/calendar/calendar.js"></script>
		<link type="text/css" rel="stylesheet" href="../../../build/calendar/assets/calendar.css">

		<script type="text/javascript" src="../../../build/container/container.js"></script>
		<link type="text/css" rel="stylesheet" href="../../../build/container/assets/container.css">

		<style>
			body { margin:5px;background:#444 }
			.mask { z-index:100;background-color:#000 }
			
			.panel-container.shadow .underlay { background-color:#666 }
			.panel .hd { padding:5px;border:none;background-color:#666 }
			.panel .bd { background-color:#000;padding:0 }
			.panel .bd img { margin:5px }
			.yui-calendar td.calcell { text-align:right;vertical-align:top;background-color:#fff;padding:0;width:75px;height:75px;font-size:150%;color:#333 }
			
			.yui-calendar .calheader { border:1px solid #EEE }
			.yui-calendar th.calweekdaycell { text-align:center;font-size:120% }
			.yui-calendar td.calcell.calcellhover { cursor:pointer; background:none; border:1px solid #FF9900; }

			.yui-calendar td.calcell.oom { background-color:#666; }

			.yui-calendar td.calcell div.photo { background-color:transparent;margin:0;position:relative;width:75px;height:75px;}
			.yui-calendar td.calcell div.photo div.hilite { display:none;background-color:yellow;z-index:5;margin:0;top:0;left:0;position:absolute;width:75px;height:75px;}

			.yui-calendar td.calcell.calcellhover div.photo div.hilite { display:block } 
			.yui-calendar td.calcell.selected div.photo div.hilite { display:block;background-color:blue }

			.yui-calendar td.calcell div.photo div.date { font-weight:lighter;z-index:1;color:#eee;position:absolute;top:5%;right:5%; }
			.yui-calendar td.calcell div.photo div.date-shadow { z-index:0;color:#000;position:absolute;top:7%;right:4% }
			.yui-calendar .calheader { font-size:200% }
		</style>

		<script>
				YAHOO.namespace("example.calendar");
				
				var conn = [];
				var photos = {};

				function init() {

					// Turn background image caching on for IE so that cell images don't need to reload each time
					try{ document.execCommand("BackgroundImageCache",false,true); }catch(ex){};
					
					// Create a Panel to display the larger version of the photo after it is clicked
					YAHOO.example.calendar.panel = new YAHOO.widget.Panel("panel", { visible:false,fixedcenter:true,modal:true,zIndex:101,draggable:false,effect:{effect:YAHOO.widget.ContainerEffect.FADE,duration:0.25} });

					YAHOO.example.calendar.panel.setHeader("Photo");
					YAHOO.example.calendar.panel.setBody("");
					YAHOO.example.calendar.panel.render(document.body);
					
					// Create a new Calendar and set its default cell renderer to our special handler.
					
					YAHOO.example.calendar.cal1 = new YAHOO.widget.Calendar("cal1","cal1Container", { pagedate:"10/2006" } );
					YAHOO.example.calendar.cal1.renderCellDefault = renderFlickrCell;
					
					YAHOO.example.calendar.cal1.selectEvent.subscribe(function(type,args,obj) {
														var selected = args[0]
														var selectedDate = selected[0];

														var year = selectedDate[0];
														var month = selectedDate[1];
														var day = selectedDate[2];

														var photo;

														if (photos[year] && photos[year][month] && photos[year][month][day]) {
															photo = photos[year][month][day];

															var recenter = function() {
																YAHOO.example.calendar.panel.cfg.setProperty("width", (this.offsetWidth + 10) + "px");
																YAHOO.example.calendar.panel.render();
																YAHOO.example.calendar.panel.center();
																YAHOO.example.calendar.panel.show();
															}

															YAHOO.example.calendar.panel.setHeader(photo.title);
															YAHOO.example.calendar.panel.setBody("<img src=\"" + photo.img + "\" />");
															
															YAHOO.util.Event.addListener(YAHOO.example.calendar.panel.body.firstChild, "load", recenter);

														}
													});

					YAHOO.example.calendar.cal1.render();
					YAHOO.example.calendar.cal1.beforeRenderEvent.subscribe(function (type,args,obj) {
																			var c;
																			for (var i=0;i<conn.length;i++) {
																					c = conn[i];
																					if (YAHOO.util.Connect.isCallInProgress(c)) {
																							YAHOO.util.Connect.abort(c);
																					}
																			}
																			conn = [];
																		  });
				}

				function setCellPhoto(o) {
					var workingDate = o.argument[0];
					var cell = document.getElementById(o.argument[1]);
					var photo = eval(o.responseText);

					var year = workingDate.getFullYear();
					var month = workingDate.getMonth()+1;
					var day = workingDate.getDate();

					if (! photos[year]) {
						photos[year] = {};
					}
					if (! photos[year][month]) {
						photos[year][month] = {};
					}

					photos[year][month][day] = photo;

					var img = photo.imgS;

					if (img) {
						if (cell.firstChild) {
							cell.firstChild.style.background = "url(" + img + ")";
						}
					}
				};

				function renderFlickrCell(workingDate, cell) {
					var year = workingDate.getFullYear();
					var month = workingDate.getMonth()+1;
					var day = workingDate.getDate();

					cell.innerHTML = "<div class=\"photo\"><div class=\"hilite\">&nbsp;</div><div class=\"date\">" + workingDate.getDate() + "</div><div class=\"date-shadow\">" + workingDate.getDate() + "</div></div>";
					YAHOO.util.Dom.setStyle(cell.firstChild.firstChild, "opacity", "0.5");
					
					var photo;
					if (photos[year] && photos[year][month] && photos[year][month][day]) {
						photo = photos[year][month][day];
					}

					if (photo) {
						if (cell.firstChild) {
							cell.firstChild.style.background = "url(" + photo.imgS + ")";
						}
					} else {
						getCellPhoto(new Date(workingDate.getTime()), cell.id);
					}

					return YAHOO.widget.Calendar.STOP_RENDER;
				};

				function getCellPhoto(workingDate, cellId) {
					
					var callback = {
						success : setCellPhoto,
						argument : [workingDate, cellId]
					}

					var month = workingDate.getMonth()+1;
					var day = workingDate.getDate();
					var year = workingDate.getFullYear();

					if (month < 10)	{
						month = "0" + month;
					}
					if (day < 10) {
						day = "0" + day;
					}
					
					var url = 'api_key=195ef39538e43108f980c597ce9cc385&date='+year+'-'+month+'-'+day+'&per_page=1&format=json';

					conn[conn.length] = YAHOO.util.Connect.asyncRequest('GET', '../assets/xhr.php?' + url, callback);
				};
				
				function jsonFlickrApi(rsp) { 
					if (rsp.stat == "ok") {
						var photo = rsp.photos.photo[0];
						photo.imgS = "http://static.flickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + "_s.jpg";
						photo.imgM = "http://static.flickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + "_m.jpg";
						photo.img = "http://static.flickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg";						
						return photo;
					} else {
						return null;
					}
				};

				YAHOO.util.Event.addListener(window, "load", init);
		</script>

	</head>
	<body>
		<div id="cal1Container"></div>
	</body>
</html>