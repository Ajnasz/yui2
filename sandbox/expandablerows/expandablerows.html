<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<title>Data Table with Expandable Rows</title>
	
	<link rel="stylesheet" type="text/css" href="../../build/fonts/fonts.css">
	<link rel="stylesheet" type="text/css" href="../../build/datatable/assets/skins/sam/datatable.css" />
	<style>
		body{ text-align: left; }
		.yui-dt-expanded{background-color:#f00;}
	</style>
	
</head>

<body class=" yui-skin-sam">


<h1>Data Table with Expandable Rows</h1>

<div class="exampleIntro">
	<p>A demonstration of the DataTable's expandable row feature.</p>
			
</div>

<div id="basic"></div>
<script type="text/javascript" src="../../build/yahoo/yahoo.js"></script> 
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="../../build/dom/dom.js"></script> 
<script type="text/javascript" src="../../build/event/event.js"></script>
<script type="text/javascript" src="../../build/dragdrop/dragdrop.js"></script>
<script type="text/javascript" src="../../build/element/element.js"></script> 
<script type="text/javascript" src="../../build/datasource/datasource.js"></script>
<script type="text/javascript" src="../../build/datatable/datatable.js"></script>
<!--script type="text/javascript" src="../../build/logger/logger.js"></script-->

<script>

YAHOO.widget.DataTable.prototype.getRecord = function(row) {
   var oRecord = this._oRecordSet.getRecord(row);

   if(!oRecord) {
       // Validate TR element
       var elRow = this.getTrEl(row);
       if(elRow) {
           // This is the line that changed
           oRecord = this._oRecordSet.getRecord(elRow.id);
       }
   }

   if(oRecord instanceof YAHOO.widget.Record) {
       return this._oRecordSet.getRecord(oRecord);
   }
   else {
       YAHOO.log("Could not get Record for row at " + row, "info", this.toString());
       return null;
   }
};

</script>

<script type="text/javascript">

//Add prototype methods
YAHOO.lang.augmentObject( 
	YAHOO.widget.DataTable.prototype , 
	{
		getRowState : function( row, key ){
		
			var	row_data = this.getRecord( row ),
					state = row_data.getData( 'yui_dt_state' );
					
			return ( state && key ) ? state[ key ] : state;
			
		},
		
		setRowState : function( row, key, value ){
		
			var	row_data = this.getRecord( row ),
					state = row_data.getData( 'yui_dt_state' );
					
			state[ key ] = value;
			return state[ key ];
			
		},
		
		_initExpandableRows : function( field, template, rowConfigs ){
			
			//Create state column
			var records = this.getRecordSet().getRecords();
			
			//Create custom events in the dataGrid scope
		   this.createEvent('beforeExpandRow');
		   this.createEvent('afterExpandRow');
		   this.createEvent('beforeCollapseRow');
		   this.createEvent('afterCollapseRow');
			
			//Augment records
			for( var i=0, l=records.length; l > i; i++ ){
				
				var	record = records[ i ]
						state_object = record.getData( 'yui_dt_state' );
				
				//Create row object if needed
				if( !state_object ){
					
					record.setData( 'yui_dt_state', {} );
					var state_object = record.getData( 'yui_dt_state' );
					
				}
				
				//Set table level state
				this.rowExpansionTemplate = template || null;
				
				//Set row state
				state_object.expanded = ( record.getData( field ) ) ? false : null //set expanded property to null if no data is available
				state_object.expandable_datakey = field;
				state_object.expandable_template = null;
				
			}//for
			
		},
		
		toggleRowExpansion : function( row ){
			
			var	state = this.getRowState( row );
			
			if( state && state.expanded ){
				
				this.collapseRow( row );
				YAHOO.util.Dom.replaceClass( row, 'yui-dt-expanded', 'yui-dt-collapsed' );
				
			} else {
				
				this.expandRow( row );
				YAHOO.util.Dom.replaceClass( row, 'yui-dt-collapsed', 'yui-dt-expanded' );
				
			}
			
		},
		
		expandRow : function( row ){
			
			var	state = this.getRowState( row );
			
			if( !state.expanded ){
				
				//If id passed, get element
				if( !YAHOO.lang.isObject( row ) ) {

					row = DOM.get(row);

				}

				//Fire custom event
				this.fireEvent( "beforeExpandRow", { row : row } );

				var	row_data = this.getRecord( row ),
						new_row = document.createElement('tr'),
						column_length = this.getFirstTrEl().getElementsByTagName('td').length,
						expanded_data = row_data.getData( state.expandable_datakey ),
						expanded_content = null,
						template = state.expandable_template || this.rowExpansionTemplate;

				//Construct expanded row body
				//this.rowExpansionTemplate
				
				new_row.className = 'yui-dt-expandablerow';
				var	new_column = document.createElement('td');
				new_column.className = 'yui-dt-expandablerow-body';
				new_column.setAttribute( "colSpan", column_length );
				
				new_column.innerHTML = '<div class="satg-expandablerow-wrapper"></div>';
				new_row.appendChild( new_column );
				
				var liner_element = new_row.getElementsByTagName( 'div' )[ 0 ];
				
				if( YAHOO.lang.isString( template ) ){

					liner_element.innerHTML = YAHOO.lang.substitute( 
						template, 
						expanded_data 
					);

				} else if( YAHOO.lang.isFunction( template ) ) {
					
					template( { 
						row_element : new_row,
						liner_element : liner_element,
						data : row_data, 
						state : state 
					
					} );

				} else {
					
					return false;
					
				}

				//Insert new row
				newRow = YAHOO.util.Dom.insertAfter( new_row, row );

				if (newRow.innerHTML.length) {

					state.expanded = true;

					//Fire custom event
					this.fireEvent( "afterExpandRow", { row : row, expanded_cell : new_column } );

					return true;

				} else {

					//Fire custom event
					this.fireEvent("afterExpandRow", { row : row } );

					return false;

				}	
				
			}
			
		},
		
		collapseRow : function( row ){
			
         //Fire custom event
         this.fireEvent("beforeCollapseRow", { row : row } );

         //If id passed, get element
         if ( !YAHOO.lang.isObject( row ) ) {

             row = DOM.get( row );

         }

			var	state = this.getRecord( row ).getData( 'yui_dt_state' ),
					next_sibling = YAHOO.util.Dom.getNextSibling( row );

         if( YAHOO.util.Dom.hasClass( next_sibling, 'yui-dt-expandablerow' ) ) {

             next_sibling.parentNode.removeChild( next_sibling );
             state.expanded = false;
				
             //Fire custom event
             this.fireEvent( "afterCollapseRow", { row : row } );

             return true

         } else {
				
             //Fire custom event
             this.fireEvent( "afterCollapseRow", { row : row } );

             return false;

         }
			
		}
	}
);

YAHOO.widget.DataTable.formatExpandRowTrigger = function(el, oRecord, oColumn, oData) {
	
	var	Dom = YAHOO.util.Dom,
			cell_element = Dom.getAncestorByTagName( el, 'td' );
	
	//TODO: Move this to expand function
	if( !this._hasExpandedRows ){
		
		this._hasExpandedRows = true;
		
		this._initExpandableRows( oColumn.key, '<img src="{image_url}" />' );
		
		this.setRowState(1,'expandableRowTemplate','Hi');
		console.log(this.getRowState(1,'expandableRowTemplate'));
		
		//Subscribe to a click event to bind to
		this.subscribe( 'cellClickEvent', function( cell_click, args ){
			
			if( Dom.hasClass( cell_element, 'yui-dt-expandablerow-trigger' ) ){
				
				var	row = YAHOO.util.Dom.getAncestorByTagName( cell_click.target, 'tr' );
				
				this.toggleRowExpansion( row );
			
			}
		
		} );
		
	}
	
	var	state_object = oRecord.getData( 'yui_dt_state' );
	
	//Marker class for the formatted cell
	Dom.addClass( cell_element, 'yui-dt-expandablerow-trigger' );
	
	//Set trigger
	if( state_object && state_object.expanded === false ){ //Row is closed
		
		Dom.addClass( cell_element, 'yui-dt-collapsed' );
		el.innerHTML = "X";
		
	} else if( state_object && state_object.expanded === true ){
		
		Dom.addClass( cell_element, 'yui-dt-expanded' );
		el.innerHTML = "L";
		
	}

}


YAHOO.util.Event.addListener(window, "load", function() {
    YAHOO.example.Basic = function() {
        var myColumnDefs = [
        
            {
            	key:"details",
					label:"",
					formatter:YAHOO.widget.DataTable.formatExpandRowTrigger,
					formatterOptions:{
					}
            },
            {
            	key:"date", 
            	formatter:YAHOO.widget.DataTable.formatDate, 
            	sortable:true, 
            	sortOptions:{
            		defaultDir:YAHOO.widget.DataTable.CLASS_DESC
            	},
            	resizeable:true
            },
            {
            	key:"quantity", 
            	formatter:YAHOO.widget.DataTable.formatNumber, 
            	sortable:true, 
            	resizeable:true
            },
            {
            	key:"amount", 
            	formatter:YAHOO.widget.DataTable.formatCurrency, 
            	sortable:true, 
            	resizeable:true
            },
            {
            	key:"title", 
            	sortable:true, 
            	resizeable:true
            }
            
        ];

        var myDataSource = new YAHOO.util.DataSource(YAHOO.example.Data.bookorders);
        myDataSource.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
        myDataSource.responseSchema = {
            fields: ["id","date","quantity","amount","title","details"]
        };

        var myDataTable = new YAHOO.widget.DataTable(
        	"basic",
            myColumnDefs, 
            myDataSource
        );
                
        return {
            oDS: myDataSource,
            oDT: myDataTable
        };
    }();
});

</script>

</body>
</html>